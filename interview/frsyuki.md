---
layout: page
title: 古橋貞之さんインタビュー
permalink: /interview/frsyuki/
---

{% include interview-head github='frsyuki' %}

5/17 Skypeにて伺いました（話し手：古橋さん、聞き手：笹田）。

__笹田__ 今日は、時間を取って下さってありがとうございます。今回は「分散ワークフローエンジン『DigDag』の実装」というタイトルですが、どういう話になるんでしょうか。

__古橋__ ワークフローエンジンとは何であり、なぜワークフローエンジンが必要か、それから実装上のテクニックについて話をしようと思います。

## DigDag とは

__笹田__ 「DigDag」というのは、ゲームの名前（[ディグダグ](https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%A3%E3%82%B0%E3%83%80%E3%82%B0)）から採ったんでしょうか。

__古橋__ いや、必ずしもそうではなく、私はディグダグをやったことがありません。偶然近い名前になりました。DAG（Directed Acyclic Graph: 有向非巡回グラフ）を掘っていく（dig）ところから、こういう名前になりました。最初はコードネームだったんですが、響きが良いので、このまま名前になりました。

__笹田__ すでに、ワークフローエンジンについては既存のものが沢山あるけれど、それらでは不足していたから作り始めた、ということでしょうか。

__古橋__ 僕たちが使いたいものにマッチしたものが無かったんですよね。

__笹田__ どのあたりがマッチしていなかったんでしょうか。利用するフィールドが違う、とかでしょうか。

__古橋__ 一番大きな要求というのは、コードとしてワークフローを定義したかったというのがあります。GUI でのドラッグアンドドロップで作るのではなく、テキストで記述し、Git でバージョン管理し、コードレビューが行える、デプロイが再現可能な形で行えるという、ソフトウェア開発で行なっているベストプラクティスでワークフローを管理したかった。これができるツールが、まず少ないです。

__笹田__ 古典的には、make があると思います。

__古橋__ はい。ワークフローエンジンって沢山あって、例えば、make や Airflow などがあります。ただ、プログラムが書ける、となると、完全にプログラマ向けになってしまうというのがあります。それを避けて、必ずしもプログラマじゃなくても使えるツールにしたかっというのがあります。具体的には、データ解析をする人たちが使えるツール。

__笹田__ GUI ではなく、テキストで記述できるが、プログラマではなくてもわかりやすい DSL を提供したかった、ということでしょうか。

__古橋__ その通りです。そのやり方は、僕がまさに Fluentd や Embulk で行なっていたことに似ていて、同じやり方を持ってこよう、というプロジェクトです。意外に、こういう方針のソフトウェアはないんですよね。

__笹田__ データ解析を目標になると、処理の分散や、分散処理も当然サポートされる、と。

__古橋__ はい。このプロジェクトのひとつの課題に、マルチテナントに対応しなければならない、というものがあります。というのも、ワークフローをサーバ側で実行したいからです。つまり、サーバにアカウントを作って、ローカルで動作を確認したワークフローを、Git のようにプッシュすると、サーバで定期的にそのワークフローが走るようにしたいんです。

__笹田__ なるほど。

__古橋__ 今、こういうツールを作るには良い時期だと思っています。というのも、Docker など、コンテナ上で隔離された専用の環境でプログラムを実行する、というシステムがいろいろ揃ってきました。これを使うと、サーバサイドで自分の実行したいプログラムを実行することが比較的簡単に行えます。例えば、Travis CI や Circle CI も、そんな感じで作られていますが、それらはテストという用途に特化したワークフローエンジンと言えると思います。

## DigDag の実装


__古橋__ 今回、実装上難しいところが 4 点ありました。

1. 限られたリソースの元でのフェアネスを考慮したタスクのスケジューリング（実行）
2. タスクのステータスの管理
3. タスクの実行（タスク間のコミュニケーションのデザイン）
4. パラメータの評価 -- YAML を使う、JavaScript を書けるように

__笹田__ それぞれ説明して貰ってもいいでしょうか。

__古橋__ はい。まず、1. はわかると思いますが、分散環境で多くの計算機リソースがある中、沢山のタスクをどうやって実行していくか決定する、というのは、一つの課題になります。しかも、それをなるべく公平に実行しないといけないわけですから。

__笹田__ なるほど。

__古橋__ 次に、2. タスクのステータスの管理です。ワークフローエンジンは、タスクの依存関係を管理し、順々に実行していくことになります。あるタイミングで実行できるかどうかは、依存しているタスクが完了しているか、または失敗しているかなどの状態で決まります。この状態を管理するのが意外に難しい。マルチテナント上で動かしたいので、これを RDB で管理しています。つまり、SQL を大量に投げて、MVCC を使って、ステータス管理をトランザクショナルに更新処理を行なっています。

__笹田__ データベースで管理するんですね。

__古橋__ ステートマシンを RDB 上で実装している、と言ってもいいかもしれません。発表では、実際のクエリをお見せできると思います。

__笹田__ DB で作るから、という難しさがあったんでしょうか。

__古橋__ そもそも、この管理が難しいというのがあります。例えば、ステートがいろいろ種類があります。待機中、実行中というのはありますが、加えて、失敗とか、リトライ待ちとか、キャンセルされた、とか。そうすると、次に実行可能なタスクのリストは必ずしも自明ではありません。しかも、複数のサーバで実行しているので、これらのステータスの変更が、複数のサーバから同時にやってくるわけです。

__笹田__ なるほど。

__古橋__ 3 番目が、タスクを実際に実行するところです。非エンジニアでも簡単に使えるようにしたいという目標があります。そのために、オペレータプラグインというのを提供しています。使う人は、このオペレータプラグインに、パラメータを指定して実行することになります。例えば、その一つは一般的な Ruby のスクリプトを実行できる、というものになります。

__笹田__ 使う人は、それを使うだけで良い、ということですね。

__古橋__ さて、この Ruby スクリプトとの間でどうやってパラメータを受け渡すか、というのは難しい問題になります。なぜなら、メソッドを探し、Ruby を Docker の中で実行し、パラメータを渡し、エラーが起きたら例外をキャッチし、適切に上に伝達し、かつその状態を次のタスクで取れるようにする、ということが必要になります。この中身の実装を発表では紹介できればいいなと思っています。

__笹田__ これは、各タスクのコミュニケーションのデザインということですかね。

__古橋__ そうです。例えば、最初のタスクは Ruby で書いたものだけど、次のタスクは他の人が Python で書いた、みたいなものにも対応しないといけません。

__笹田__ なるほど。では 4 番目はどうでしょう。

__古橋__ パラメータをどうやって評価するか、という問題になります。単純なワークフローは、単に実行するだけですが、例えばタスクの実行結果によって、次に動かすタスクを変えたい、とか、失敗したらどうする、といった分岐が入ってくることになります。

__笹田__ 使いたいですね。

__古橋__ つまり、前のタスクのパラメータを使って次のタスクの実行を変えたい、と。それから、外から与えらたパラメータがあったりとかします。それをどうやってワークフローで使えるようにするか、というのが結構難しい問題になります。なぜなら、ここは一番ユーザが利用するところだからです。さらに、いろんなユーザがいるので、いろんな要求がある。そして、あまり複雑にすると、非エンジニアが使えなくなってしまう。

__笹田__ 難しいところですね。

__古橋__ そこで、DigDag では、YAML を使うようにしています。YAML では、当然パラメータなどを指定出来ます。さらに、その中に JavaScript を書けるようにしています。

__笹田__ JavaScript in YAML。

__古橋__ その JavaScript を評価して、外から変数の値を入れらるようになっていて、その結果をパラメータとしてオペレータに渡せるようになっています。

__笹田__ つまり、DSL のデザインとして、YAML とその中の JavaScript を提供しており、単純な場合は YAML だけ書いておけばよく、何か凝ったことがしたければ、JavaScript でロジックが記述できるよ、ということでしょうか。

__古橋__ その通りです。

__笹田__ 技術的困難だった 4 点について、1、2 がエンジニアリングの話で、3、4 がデザインの話、ということになるでしょうか。

__古橋__ そうなると思います。

__笹田__ 大きなシステムだから、沢山の話が出てきて本当に面白そうですね。

## そのほか


__古橋__ 例えば、笹田さんがワークフローエンジンで解決したい問題ってありますか？

__笹田__ 直接解決したい問題じゃないんですが、分散システム上にセットアップするのが簡単だといいな、と思います。

__古橋__ そういう要求は凄い一般的です。ある会社で、機械学習を作ったけれど、それが R で書かれていて、分散実行できない状況だけど、データ量が多いから当然分散処理したい。そこで、凄い単純なシステムを作って便利だった、という話がありました。入ってきたデータを分割して、各サーバに分散し、GitHub においてあるスクリプトで処理して結果を返すだけのシステム。DigDag は、例えば、そういうのも簡単にできるようにしようと思っています。

__笹田__ 良さそう。

__古橋__ そのために、インストールを凄い簡単にしたいと思っています。僕が作るツールは、基本的に 1 コマンドでインストール出来るようにしています。タスクを実行するエージェントは、プログラムなどデータを取ってきて、それを評価する、というようにしようと思っています。

__笹田__ そのエージェントを動かすマシン上で、1 コマンド実行するということになりますか。

__古橋__ はい。そのマシン上で、サーバのアドレスを指定してコマンドを実行すると、サーバから実行に必要なバイナリなどをとってきて、すぐに実行できるようになります。

__笹田__ それは便利そうですね。

__古橋__ まだ、全部はできていないですけどね。

__笹田__ タスクの状況を、絵で綺麗に見れたりするんでしょうか。

__古橋__ そこは完全に TODO ですね。今のところ、コマンドラインだけです。リトライの指示や、ワークフローの再定義なども、現状はコマンド操作で行なうことになります。

__笹田__ なるほど、楽しみです。

__古橋__ これで、Treasure Data を使う人が増えてくれるといいですね。

__笹田__ なるほど、Treasure Data 上では、すでに環境が整っているんですもんね。

__古橋__ 一個重要なコンセプトは、ローカルで定義したワークフローを、そのままリモートで実行できるというところです。手元で開発して、それをプッシュすれば、サーバ上でちゃんと動く。ちゃんと、オペレータを使うとか、スクリプトはコンテナで使うといった、標準的な方法を使っていれば、問題無くできると思っています。他のツールでは、必ずしもそうなっていないことが多いですよね。サーバにいろいろセットアップしないといけなくて、再現性のない環境に依存することになってしまう。DigDag では、完全に再現性のあるワークフローを作りたいと思っています。データサイエンティスト界隈でも、それが問題になっていて、論文の結果が再現できない、といったことが言われているそうです。

__笹田__ 大事な特長ですね。

__古橋__ 今回、できるだけ質疑応答の時間を取りたいと思っています。というのも、ワークフローエンジンへの要求を聞いてみたい、というのがあります。

__笹田__ いろいろ聞けるといいですね。あと、すぐ後に懇親会があるので、そこで議論をしてもらうこともできると思います。では、発表楽しみにしています。今日はお忙しいところ、ありがとうございました。

