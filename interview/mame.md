---
layout: page
title: 遠藤侑介さんインタビュー
permalink: /interview/mame/
---

{% include interview-head github='mame' %}

5/14 チャットにて伺いました（話し手：遠藤さん、聞き手：笹田）。

__笹田__ 今回、NES（ファミコン）のエミュレータを ruby で書いていた、ということですね。[まめめも](http://d.hatena.ne.jp/ku-ma-me/20160401/p1) に色々詳しく書かれていますが、暇だったんですか？

__遠藤__ はい。

__笹田__ 仕様は公開されているんでしょうか。

__遠藤__ NesDev Wikiに、[有志の解析結果](http://wiki.nesdev.com/w/index.php/NES_reference_guide)が公開されています。NES エミュレータ開発者はみんなここを見ているようです。テスト用の ROM もここに公開されている親切設計。あとは、既存のエミュレータのソースコードを読むということですね。

__笹田__ なんでまた NES だったんでしょうか。

__遠藤__ スーパーファミコンは無理だと思ったからです。

__笹田__ ファミコンは簡単でした？

__遠藤__ いえ、これもあんまりできると思っていませんでした。

__笹田__ でも、出来ちゃったと。難しいのは性能的にでしょうか。それとも、仕様の大きさ的に？

__遠藤__ 性能的にですね。

__笹田__ じゃあ、意外と Ruby でもなんとかなった、ということですね。ハードウェア全部エミュレーションしてるんでしょうか。

__遠藤__ もちろんです。256 × 240 の画面を 60 fps で更新しないといけなくて、60 フレーム分だけ配列に代入するループだけで 0.2 秒とかかかります。画面描画だけでそのくらいかかるわけです。60 fps でシステムを動かすためには、60 フレームの全処理を 1 秒で終える必要があるので、ピクセルの色の決定だの CPU エミュレーションだのを残りの 0.8 秒で行なわなければなりませんでした。

__笹田__ 無理ゲーじゃないですか。

__遠藤__ そういう無理ゲーでした

__笹田__ ゲーム動きました？

__遠藤__ はい。市販ゲームはスーパーマリオブラザーズしか試してないですが。マリオはわざわざ秋葉原で買ってきました。吸出し機も自作して。[こーどねーむ「ホンコン」 with Arduino](http://hongkongarduino.web.fc2.com/) をマネただけですけどね。

__笹田__ どの程度のクオリティで動いたんでしょうか

__遠藤__ 普通に遊んでで違和感はないです。明らかにピクセルが化けてるとかそういうのはありません。また、明らかな遅延を感じるとかもないですね。

__笹田__ 凄いですね。

__遠藤__ Ruby すごいですね。

__笹田__ 今回の発表は、そのための最適化技法って感じですか。

__遠藤__ はい、如何に実装したかですね。

__笹田__ どういうプラットフォームで動きますか？

__遠藤__ SDL2 が動けばなんでも。Windows でも、mingw なら動いてますね。mswin だと動かないという噂もあります。

__笹田__ 最適化の話というと、こんな感じですか。

1. 普通に書けば良かった
2. 工夫したらいけた
3. 超絶技巧（最適化）でいけた
4. どうやっても駄目だった

__遠藤__ はい。比較的普通な Ruby コードで 20 fps まで頑張って、そこからコードの綺麗さを捨てて頑張って 60 fps を目指したというところですね。

__笹田__ 1. ～ 3. の話ですね。

__遠藤__ あと、これはやっていないことの話なのですが、NES エミュレータっていうのは、簡単な ROM を動かすところまではわりと簡単なんですが、難しい ROM を動かすためにはいろいろやらないとダメなんですよね。NES のカートリッジって単なるソフトウェアじゃなくて、そのゲーム専用の回路とか入ってるんです。エミュレータは個々のゲームの回路も実装しないといけない。なので、ベーシックな機能の ROM しか動かない状態です。マリオ 3 とかで使われてる回路（MMC3）のエミュレーションはまだまだ遅いです。特定の信号線が立ち上がるタイミングをトリガーに動いたりするので、エミュレーションでそのへんの機能を抽象化出来ないから、ハードウェアを真面目にエミュレーションしないといけない。

__笹田__ 行なった最適化を紹介してもらっていいですか。

__遠藤__ [日記](http://d.hatena.ne.jp/ku-ma-me/20160401/p1)に書いてある部分は、20 fps を 60 fps にするためにやったことですね。

> 具体的には、まず自分自身のソースコードを読み込んで、メソッドインライン展開したり、簡単な部分計算したり、fastpath をこしらえたりして、コードクローンだらけの高速だけど最悪なコードを内部的に生成します。この処理は Ruby の得意とする文字列処理なんで、正規表現を駆使して適当にやってます。で、生成されたプログラム文字列を `eval` することでボトルネックの処理を置き換えます。

20 fps 達成までにも、そこそこアルゴリズムレベルの最適化をやっています。

__笹田__ というと？

__遠藤__ 一番最初、本当にナイーブに書いたら 3 fps とかだったんですよ。それを 20 fps にした、約 7 倍。図解しないとわかりにくいんですが、実機だと CPU と GPU の 2 つが同時に動作するわけですが、エミュレーションでは並列実行できないので、ナイーブな実装だと CPU を 1 クロック分すすめて、それから GPU を対応するクロック分進める、というのを繰り返してとても遅いです。`loop { @cpu.step; @gpu.step }` みたいな感じで、メソッド呼び出しが多すぎる。そこで、まず CPU が GPU と通信するまで CPU だけエミュレーションして、通信したらそこで止めて、CPU に追いつくまで GPU をエミュレーションする、ということを行ないました。実際には双方向なのでもうちょっと難しいですが。ちなみにこの方法は自分のオリジナルの方法じゃなくて、NES 業界ではわりと一般的な方法（キャッチアップ法）です。

__笹田__ なるほど。主にメソッド呼び出しが重いですか。

__遠藤__ やっぱりメソッド呼び出しが遅いですねえ

__笹田__ ハードウェアエミュレーションだと、1 メソッドあたりの実体が短いので、それを感じやすい、って話な気もしますが。

__遠藤__ かもしれません。で、このキャッチアップ法でだいたい 10 fps になって、GPUのエミュレーションをアルゴリズムレベルで大きく工夫したあと（詳しくは発表で）、細かい最適化を積み重ねて 20 fps にしました。

__笹田__ 細かい最適化。

__遠藤__ ビット演算がわりと遅いんですよね。これを配列参照に置き換えました。`0x23C0 | (addr & 0x0C00) | (addr >> 4 & 0x0038) | (addr >> 2 & 0x0007)` こういうのとかを、`LUT[addr]` に置き換えてしまう。流石に 1 個のビット演算を置き換えるわけではありません。

__笹田__ なるほど。

__遠藤__ こんなコードを綺麗な Ruby コードと言うかどうかは微妙だけども。あとはオブジェクトが生成されないようにするとか。GC 以前にオブジェクト生成自体が遅いので。初期化が終わったら 1 つもオブジェクトを作らないようにしました。MMC3 は除いて。

__笹田__ なんか組込みみたいな話になってきましたね。

__遠藤__ `malloc` 禁止みたいな。NES エミュレータに関して言えば、オブジェクトを作らないようにコードを書くのは大して難しくなかったです。文字列使わないですからね。

__笹田__ なるほど。

__遠藤__ そうそう、メモリ表現するのに文字列使いたいと思うかもだけど、整数の配列に比べて全然遅いので話にならない。

__笹田__ 途中書き換えが？

__遠藤__ あんまりちゃんと調べてないけど、読み出しも書き出しも遅そうな感じでした。

__笹田__ 配列偉い。という、NES を作る上でのパフォーマンスチューニング技法について、ご発表頂ける感じでしょうか

__遠藤__ というのが半分と、後は 20 fps を 60 fps にする時にやったコード書き換え実験ですね。こちらは、一般の Ruby ユーザがやるべきとは思わないですけどね。メソッド定義とかしたくなくなるので心の弱い人は見てはいけない。普通は読みやすいコードを書くべきだと思います。

__笹田__ 聞く人が予習しておくべき話はなんでしょうね。[日記](http://d.hatena.ne.jp/ku-ma-me/20160401/p1)読んでおけ、とかでしょうか。

__遠藤__ クロックって何？っていう人には前半はよくわからないかもしれない

__笹田__ 「ハードウェアに関する基礎的な知識があると望ましい。」って発表概要にも書いてありましたね。

__遠藤__ まあ、そこまで知らなくても大丈夫な気はしますが。

__笹田__ どれくらいまでを基礎というかは、遠藤さんのレベルを考えると難しい気がしますが。

__遠藤__ あと CPU は意外に話題に出てこない。NES エミュレーションのボトルネックは GPU なんです。エミュレーション実行時間の 80 % は GPU。

__笹田__ そもそも、GPU が乗っていることすら知りませんでした。

__遠藤__ ゲーム専用 GPU を載せたことが、ファミコンが勝利した主因ですね。

__笹田__ ちなみに、音の制御は？

__遠藤__ 44100 Hz とかだと、原理的には 1 秒間に 44100 回の処理でいいわけなので、全然処理時間はかからないです。

__笹田__ 難しくなかった、と。

__遠藤__ 実装するアイテムは多いのでそういう意味では難しいけど、最適化には全然関わってないです。

__笹田__ 音は、おかしいとすぐにわかるし、タイミングに対して凄くシビアだと思うんだけど、そういう同期を取るのも難しくない、と。

__遠藤__ 何も考えずにフレームごとにフラッシュしてるだけですね。多少、SDL2 のサウンドバッファで遅延とかするんだろうけど、自分の感覚では違和感ないです。

__笹田__ 60 fps 出ればよい、と。60 fps 超えてもだめですよね、その辺のタイミング制御は何でやってるんですか？

__遠藤__ `SDL_GetTicks()` と `SDL_Delay()` でやっています。普通にゲーム作る感じです。

__笹田__ なるほど、ありがとうございました。遠藤さんの超絶技巧の新機軸、楽しみにしています。

__遠藤__ わりとすべて話したのでもう発表聞かなくても行けるな。

__笹田__ あと、本が展示されるんですよね。

__遠藤__ 発表には関係ないけど『[あなたの知らない超絶技巧プログラミングの世界](http://gihyo.jp/book/2015/978-4-7741-7643-7)』を東京 Ruby 会議 11 の会場で展示予定です。

__笹田__ 当日、手にとって、読んでみることができると思うので、気に入ったら、その辺の本屋で買ってきて、遠藤さんにサインを貰えるということですね。本日は、ありがとうございました。

